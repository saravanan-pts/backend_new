stages:
  - build
  - deploy

# Global OIDC token configuration
default:
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: api://AzureADTokenExchange

variables:
  AZURE_ACR_NAME: "irmaiuatregistry"
  AZURE_AKS_CLUSTER: "rg-irmai-uat-us-1-cluster"
  AZURE_RESOURCE_GROUP: "rg-irmai-uat-us-1"
  IMAGE_NAME: "irmai-kg-backend"
  TF_STATE_KEY: "irmai-kg-backend.tfstate"

build_image:
  stage: build
  # UPDATED: Use the official Azure CLI image so the 'az' command is available
  image: mcr.microsoft.com/azure-cli:latest
  services:
    - docker:24.0.5-dind
  script:
    - az login --service-principal -u $AZURE_CLIENT_ID -t $AZURE_TENANT_ID --federated-token $GITLAB_OIDC_TOKEN
    - az acr login --name $AZURE_ACR_NAME
    - docker build -t $AZURE_ACR_NAME.azurecr.io/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA -t $AZURE_ACR_NAME.azurecr.io/$IMAGE_NAME:latest .
    - docker push --all-tags $AZURE_ACR_NAME.azurecr.io/$IMAGE_NAME

deploy_aks:
  stage: deploy
  image: hashicorp/terraform:light
  script:
    - az login --service-principal -u $AZURE_CLIENT_ID -t $AZURE_TENANT_ID --federated-token $GITLAB_OIDC_TOKEN
    - az aks get-credentials --resource-group $AZURE_RESOURCE_GROUP --name $AZURE_AKS_CLUSTER --admin
    - cd terraform
    - terraform init -backend-config="key=$TF_STATE_KEY"
    - terraform apply -auto-approve \
        -var="container_image=$AZURE_ACR_NAME.azurecr.io/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA" \
        -var="openai_endpoint=$AZURE_OPENAI_ENDPOINT" \
        -var="openai_key=$AZURE_OPENAI_API_KEY" \
        -var="openai_deployment=$AZURE_OPENAI_DEPLOYMENT_NAME" \
        -var="openai_embedding=$AZURE_OPENAI_EMBEDDING_MODEL" \
        -var="openai_generation=$AZURE_OPENAI_GENERATION_MODEL" \
        -var="openai_version=$AZURE_OPENAI_API_VERSION" \
        -var="cosmos_endpoint=$COSMOS_GREMLIN_ENDPOINT" \
        -var="cosmos_db=$COSMOS_GREMLIN_DATABASE" \
        -var="cosmos_container=$COSMOS_GREMLIN_CONTAINER" \
        -var="cosmos_key=$COSMOS_GREMLIN_KEY"